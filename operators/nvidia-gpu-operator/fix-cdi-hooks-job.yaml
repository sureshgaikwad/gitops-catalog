apiVersion: batch/v1
kind: Job
metadata:
  name: fix-cdi-hooks
  namespace: nvidia-gpu-operator
  annotations:
    argocd.argoproj.io/sync-wave: "10"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: fix-cdi-hooks
    spec:
      serviceAccountName: fix-cdi-hooks
      restartPolicy: OnFailure
      containers:
      - name: fix-cdi
        image: quay.io/openshift/origin-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "============================================================"
          echo "Fixing CDI Hook Issues on All GPU Nodes"
          echo "============================================================"
          echo ""
          
          # Wait for GPU operator to be ready
          echo "1. Waiting for NVIDIA GPU Operator to be ready..."
          MAX_WAIT=600
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            if oc get daemonset -n nvidia-gpu-operator nvidia-container-toolkit-daemonset 2>/dev/null | grep -q "1/1"; then
              echo "   ✓ GPU Operator is ready"
              break
            fi
            echo "   Waiting for GPU Operator... ($ELAPSED/$MAX_WAIT seconds)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          # Wait for CDI specs to be generated
          echo ""
          echo "2. Waiting for CDI specs to be generated..."
          sleep 30
          
          # Get all nodes with GPUs
          echo ""
          echo "3. Finding nodes with GPUs..."
          GPU_NODES=$(oc get nodes -l nvidia.com/gpu.present=true -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
          
          if [ -z "$GPU_NODES" ]; then
            echo "   Checking all nodes for GPU labels..."
            GPU_NODES=$(oc get nodes -o jsonpath='{.items[*].metadata.name}')
          fi
          
          if [ -z "$GPU_NODES" ]; then
            echo "   ERROR: No nodes found!"
            exit 1
          fi
          
          echo "   Found nodes: $GPU_NODES"
          echo ""
          
          # Fix CDI spec on each node using oc debug
          FIXED_COUNT=0
          FAILED_COUNT=0
          
          for NODE in $GPU_NODES; do
            echo "4. Fixing CDI spec on node: $NODE"
            
            # Pre-encoded Python script (base64) to avoid YAML parsing issues with heredocs
            PYTHON_SCRIPT_B64="aW1wb3J0IGpzb24KaW1wb3J0IHN5cwogCmNkaV9maWxlID0gIi92YXIvcnVuL2NkaS9rOHMuZGV2aWNlLXBsdWdpbi5udmlkaWEuY29tL2dwdS5qc29uIgogCnRyeToKICAgIHdpdGggb3BlbihjZGlfZmlsZSwgInIiKSBhcyBmOgogICAgICAgIGRhdGEgPSBqc29uLmxvYWQoZikKICAgIAogICAgIyBSZW1vdmUgYWxsIGhvb2tzCiAgICBpZiAiY29udGFpbmVyRWRpdHMiIGluIGRhdGE6CiAgICAgICAgaWYgImhvb2tzIiBpbiBkYXRhWyJjb250YWluZXJFZGl0cyJdOgogICAgICAgICAgICBwcmludChmIiAgICBSZW1vdmluZyB7bGVuKGRhdGFbJ2NvbnRhaW5lckVkaXRzJ11bJ2hvb2tzJ10pfSBob29rcy4uLiIpCiAgICAgICAgICAgIGRhdGFbImNvbnRhaW5lckVkaXRzIl1bImhvb2tzIl0gPSBbXQogICAgICAgIAogICAgICAgICMgU2V0IGVudmlyb25tZW50IHZhcmlhYmxlcwogICAgICAgIGRhdGFbImNvbnRhaW5lckVkaXRzIl1bImVudiJdID0gWwogICAgICAgICAgICAiTlZJRElBX0NUS19MSUJDVURBX0RJUj0vdXNyL2xpYjY0IiwKICAgICAgICAgICAgIk5WSURJQV9WSVNJQkxFX0RFVklDRVM9YWxsIgogICAgICAgIF0KICAgICAgICBwcmludCgiICAg4oiSIFNldCBOVklESUFfVklTSUJMRV9ERVZJQ0VTPWFsbCIpCiAgICAKICAgICMgV3JpdGUgdGhlIGZpeGVkIHNwZWMKICAgIHdpdGggb3BlbihjZGlfZmlsZSwgInciKSBhcyBmOgogICAgICAgIGpzb24uZHVtcChkYXRhLCBmLCBpbmRlbnQ9MikKICAgIAogICAgcHJpbnQoIiAgIOKIkiBDREkgc3BlYyBmaXhlZCBzdWNjZXNzZnVsbHkiKQogICAgCmV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgIHByaW50KCIgICDwn5KPIENESSBzcGVjIGZpbGUgbm90IGZvdW5kIikKICAgIHN5cy5leGl0KDApCmV4Y2VwdCBqc29uLkpTT05EZWNvZGVFcnJvciBhcyBlOgogICAgcHJpbnQoZiIgICDiiJMgRXJyb3IgcGFyc2luZyBKU09OOiB7ZX0iKQogICAgc3lzLmV4aXQoMSkKZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgcHJpbnQoZiIgICDiiJMgRXJyb3I6IHtlfSIpCiAgICBzeXMuZXhpdCgxKQ=="
            
            oc debug node/$NODE -- chroot /host /bin/bash -c "
              set -e
              CDI_SPEC_FILE=\"/var/run/cdi/k8s.device-plugin.nvidia.com-gpu.json\"
              
              if [ ! -f \"\$CDI_SPEC_FILE\" ]; then
                echo '   ⚠ CDI spec file not found, skipping...'
                exit 0
              fi
              
              # Backup the original file
              if [ ! -f \"\${CDI_SPEC_FILE}.backup\" ]; then
                cp \"\$CDI_SPEC_FILE\" \"\${CDI_SPEC_FILE}.backup\"
                echo '   ✓ Created backup'
              fi
              
              # Decode and run Python script
              echo '$PYTHON_SCRIPT_B64' | base64 -d | python3
            " && FIXED_COUNT=$((FIXED_COUNT + 1)) || FAILED_COUNT=$((FAILED_COUNT + 1))
            
            echo ""
          done
          
          echo "============================================================"
          echo "CDI Hook Fix Complete"
          echo "============================================================"
          echo "Nodes fixed: $FIXED_COUNT"
          echo "Nodes failed: $FAILED_COUNT"
          echo ""
          
          if [ $FAILED_COUNT -gt 0 ]; then
            echo "WARNING: Some nodes failed to fix."
            exit 1
          fi
          
          echo "✓ All nodes fixed successfully!"
          echo ""
          echo "Note: The CDI spec files may be regenerated by the container-toolkit"
          echo "daemonset. If the issue persists, restart the daemonset."
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi

